#!/bin/bash

set -eu
trap exit INT TERM

dist="packaging/bin"
target="linux/amd64"

package_service() {
  local arch=${2#*/}
  local platform=${2%%/*}
  local output=${1}/${platform}-${arch}
  if [ -f ${output} ] ; then
    rm -f ${output}
  fi

  echo "[info] packaging for ${platform}/${arch}"

  case ${arch} in

    arm)
      GOOS=${platform} \
      GOARM=7 \
      CC=arm-linux-gnueabihf-gcc \
      GOARCH=arm \
      CGO_ENABLED=1 \
      \
      go build -a -o ${output} || {
        (>&2 echo "unable to build for ${platform}/arm")
        exit 1
      }
    ;;

    *)
      GOOS=${platform} \
      GOARCH=${arch} \
      CGO_ENABLED=1 \
      \
      go build -a -o ${output} || {
        (>&2 echo "unable to build for ${platform}/${arch}")
        exit 1
      }
    ;;

  esac

  chmod +x ${output}
}

while [ $# -gt 0 ] ; do
key="$1"

case $key in

  --target)
    target="$2"
    shift
    shift
  ;;

  -o|--output)
    dist="$2"
    shift
    shift
  ;;

  *)
    shift
  ;;

esac
done

echo "[info] cleaning"
go clean

package_service ${dist} ${target}

echo "[info] done"
