#!/bin/bash

set -eu
trap exit INT TERM

TARGET_PACKAGE=""

while [ $# -gt 0 ] ; do
key="$1"

case $key in

  --pkg)
    TARGET_PACKAGE="$2"
    shift
    shift
  ;;

  *)
    shift
  ;;

esac
done

if [ ! "${TARGET_PACKAGE}" ] ; then
  (>&2 echo "[error] target package not provided")
  exit 1
fi

scan() {
  if [ -f ${1} ] ; then
    gofmt -s -w ${1}
    /go/bin/golint ${1}
    /go/bin/misspell ${1}
    /go/bin/prealloc ${1}
    /go/bin/gocyclo -over 15 ${1}
    /go/bin/prealloc ${1}
    /go/bin/goconst ${1}
  fi
}

find /go/src/github.com/jancajthaml-openbank/${TARGET_PACKAGE} \
  -name "*.go" \
  -not \
  -path "*vendor/*" \
\
| sort -u \
| while read f ; do
  scan ${f}
done
