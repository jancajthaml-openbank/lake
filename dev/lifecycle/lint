#!/bin/bash

set -eu
trap exit INT TERM

TARGET_PACKAGE=""

while [ $# -gt 0 ] ; do
key="$1"

case $key in

  --pkg)
    TARGET_PACKAGE="$2"
    shift
    shift
  ;;

  *)
    shift
  ;;

esac
done

if [ -z "${TARGET_PACKAGE}" ] ; then
  (>&2 echo "[error] target package not provided")
  exit 1
fi

################################################################################

lifecycle::lint::file() {
  local file="$1"
  if [ -z ${file} -o ! -f ${file} ] ; then
    return
  fi
  (gofmt -s -w ${file} || :)
  (/go/bin/golint -min_confidence 0.5 ${file} || :)
  (/go/bin/misspell ${file} || :)
  (/go/bin/prealloc ${file} || :)
  (/go/bin/gocyclo -over 15 ${file} || :)
  (/go/bin/prealloc ${file} || :)
  (/go/bin/goconst ${file} || :)
  (/go/bin/ineffassign ${file} || :)
}

lifecycle::lint() {
  local dir="$1"
  if [ -z ${dir} -o ! -d ${dir} ] ; then
    return
  fi
  find $dir \
    -name "*.go" \
    -not \
    -path "*vendor/*" \
  \
  | sort -u \
  | while read f ; do
    lifecycle::lint::file ${f}
  done
}

################################################################################

lifecycle::lint ${GOPATH}/src/github.com/jancajthaml-openbank/${TARGET_PACKAGE}
